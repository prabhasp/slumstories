<html>
<head>
    <title> Stories of our slums </title>
<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="lib/leaflet/leaflet.ie.css" />
<![endif]-->
<style>
body {
  margin:0;
}
</style>
<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/underscore-min.js"></script>
<script src="lib/leaflet/leaflet.js"></script>
<script src="http://slumstories.tumblr.com/api/read/json"></script>
</head>
<body>
<div id="storyMap" style="width: 100%; height: 100%">Loading ...</div>
<script type="text/javascript" language="javascript">
    // initialize the map
    var map = new L.Map('storyMap');
    var ourdata;
    var queryString = '<osm-script> <query type="node"> <has-kv k="locality" v="slum_community"/> <bbox-query s="27.6039" n="27.7999" w="85.2405" e="85.4558"/> </query> <print/> </osm-script>';

    var tagToObj = function(tag) {
        tags = {};
        _.each(tag, function (t) { 
            tags[$(t).attr('k')] = $(t).attr('v'); 
        });
        return tags; 
    };
    var tagToMarkerObj = {};
    $.ajax({ type: 'POST', 
             url: 'http://www.overpass-api.de/api/interpreter',
             data: queryString,
             dataType: 'text',
             success: function(data) {
                 ourdata = data;
                 _.each($(data).find('node'), function (n) {
                     var $n = $(n);
                     var tag = tagToObj($n.find('tag'));
                     var marker = new L.Marker(
                        new L.LatLng($n.attr('lat'), $n.attr('lon')));
                     marker.bindPopup(tag.name || '');
                     if(tag.name)
                        tagToMarkerObj[tag.name.toLowerCase()] = marker;
                     map.addLayer(marker);
                     
                 });
                processTumblrData();
             }});

    var tiles = new L.TileLayer(
        'http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
        { attribution: 'Tiles from MapQuest; data from OpenStreetmap and its contributors', maxZoom: 18});
    map.addLayer(tiles);
    map.setView(new L.LatLng(27.7,85.3), 13);


    function processTumblrData() {
        // DEBUG //console.log(_.keys(tagToMarkerObj));
        _.each(tumblr_api_read.posts, function(post) {
            var html = function($obj) { return $('<p>').append($obj).html(); };
            if (post.tags.length === 0) {
                console.log('Post found, but not tag to place post; post.id: ', post.id);
                return;
            } 
            var thisMarker = tagToMarkerObj[post.tags[0]]; 
            if (!thisMarker) {
                console.log('Post found, and tag found, but no matching marker; post.id: ', 
                    post.id, ' tag: ', post.tags[0]);
            }
            else if (post['photo-caption']) { // this is a photo
                thisMarker.bindPopup('<img src="' + post['photo-url-250'] + '"/>');
            } else if (post['video-caption']) { // this is a video
                thisMarker.bindPopup(post['video-player-250']);
            } else if (post['regular-body']) { // this is text
                thisMarker.bindPopup('<h2>' + post['regular-title'] + '</h2> <p> ' + post['regular-body'] + '</p>');
            } else {
                console.log('Post found, but cant determine type; post.id: ', post.id);
            }
        });
    }
</script>
</body>
</html>
