<html>
<head>
    <title> Stories of our slums </title>
<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="lib/leaflet/leaflet.ie.css" />
<![endif]-->
<style>
body {
  margin:0;
}
</style>
<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/underscore-min.js"></script>
<script src="lib/leaflet/leaflet.js"></script>
</head>
<body>
<div id="storyMap" style="width: 100%; height: 100%">Loading ...</div>
<script type="text/javascript" language="javascript">
    // initialize the map
    var map = new L.Map('storyMap');
    var ourdata;
    var queryString = '<osm-script> <query type="node"> <has-kv k="locality" v="slum_community"/> <bbox-query s="27.6039" n="27.7999" w="85.2405" e="85.4558"/> </query> <print/> </osm-script>';

    var tagToObj = function(tag) {
        tags = {};
        _.each(tag, function (t) { 
            tags[$(t).attr('k')] = $(t).attr('v'); 
        });
        return tags; 
    };
    $.ajax({ type: 'POST', 
             url: 'http://www.overpass-api.de/api/interpreter',
             data: queryString,
             dataType: 'text',
             success: function(data) {
                 ourdata = data;
                 _.each($(data).find('node'), function (n) {
                     var $n = $(n);
                     var tag = tagToObj($n.find('tag'));
                     var marker = new L.Marker(
                        new L.LatLng($n.attr('lat'), $n.attr('lon')));
                     marker.bindPopup(tag.name || '');
                     htmlFromTumblr(tag.name);
                     map.addLayer(marker);
                     
                 });
             }});

    function htmlFromTumblr(slumName) {
        var scriptTag = document.createElement('SCRIPT');
        var tumblrURL = "http://slumstories.tumblr.com/api/read/json?num=1&tagged=";
        tumblrURL = tumblrURL + slumName;
        document.getElementsByTagName('head')[0].appendChild(scriptTag);
        
        //return html;
    }


    var tiles = new L.TileLayer(
        'http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
        { attribution: 'Tiles from MapQuest; data from OpenStreetmap and its contributors', maxZoom: 18});
    map.addLayer(tiles);
    map.setView(new L.LatLng(27.7,85.3), 13);

</script>
</body>
</html>
